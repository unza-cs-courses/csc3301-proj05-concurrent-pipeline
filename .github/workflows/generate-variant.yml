name: Generate Student Variant

on:
  # Runs automatically on first push (when student accepts assignment)
  push:
    branches: [main, master]
  # Can also be triggered manually
  workflow_dispatch:
    inputs:
      student_id:
        description: 'Student ID (leave empty to extract from repo name)'
        required: false
        type: string

jobs:
  generate:
    name: Generate Unique Variant
    runs-on: ubuntu-latest
    # Skip if this is a template repo (only run on student repos)
    if: ${{ !github.event.repository.is_template }}

    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Extract student ID from repo name
      id: extract_id
      run: |
        if [ -n "${{ inputs.student_id }}" ]; then
          STUDENT_ID="${{ inputs.student_id }}"
        else
          REPO_NAME="${{ github.repository }}"
          REPO_NAME="${REPO_NAME#*/}"
          ASSIGNMENT_SLUG="proj05-concurrent-pipeline"
          STUDENT_ID="${REPO_NAME#${ASSIGNMENT_SLUG}-}"
        fi
        echo "student_id=$STUDENT_ID" >> $GITHUB_OUTPUT
        echo "Extracted student ID: $STUDENT_ID"

    - name: Check if variant already exists
      id: check_variant
      run: |
        if [ -f ".variant_config.json" ]; then
          EXISTING_ID=$(python3 -c "import json; print(json.load(open('.variant_config.json')).get('student_id', ''))" 2>/dev/null || echo "")
          if [ "$EXISTING_ID" = "${{ steps.extract_id.outputs.student_id }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Valid variant exists for $EXISTING_ID, skipping"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Stale variant (was '$EXISTING_ID', need '${{ steps.extract_id.outputs.student_id }}'). Regenerating."
          fi
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "No variant found, will generate"
        fi

    - name: Generate variant configuration
      if: steps.check_variant.outputs.exists == 'false'
      run: |
        python scripts/variant_generator.py "${{ steps.extract_id.outputs.student_id }}"

    - name: Generate personalized assignment
      if: steps.check_variant.outputs.exists == 'false'
      run: |
        python scripts/generate_assignment.py

    - name: Commit variant files
      if: steps.check_variant.outputs.exists == 'false'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add .variant_config.json ASSIGNMENT.md
        git commit -m "Generate unique variant for student" || echo "No changes to commit"
        git push
